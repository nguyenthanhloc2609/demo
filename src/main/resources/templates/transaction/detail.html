<script type="text/javascript" th:inline="javascript">
    $(function () {
        const pagination = new Pagination();
        var current_date = window.localStorage.getItem("date")
        var list_tran = [];
        var edit_mode = undefined;
        $("#head-title").html("Bảng thu chi trong ngày " + current_date)

        getListProcedure();

        // getListCustomer();

        function getListCustomer() {
            console.log("getListCustomer")
            getRequest({
                url: "/customer/list?limit=99999&offset=0",
                success: function (data) {
                    var listCustomer = data['list'];

                    console.log(listCustomer);
                },
                error: function (e) {
                    console.log(e);
                }
            });
        }

        function getListProcedure() {
            console.log("getListProcedure")
            getRequest({
                url: "/procedure/list?limit=99999&offset=0",
                success: function (data) {
                    var listProcedure = data['list'];
                    var html = '';
                    for (idx in listProcedure) {
                        html += '<option value="' + listProcedure[idx].code + '">' + listProcedure[idx].name + '</option > '
                    }
                    $('#kt_select2_3_modal').html(html);

                },
                error: function (e) {
                    console.log(e);
                }
            });
        }

        initTransactionsList();

        function initTransactionsList() {
            pagination.reset();
            loadTransactionsList();
        }

        function loadTransactionsList() {
            var offset = pagination.offset() || 0;
            var limit = pagination.limit() || 5;
            getRequest({
                url: "/transaction/getByDate?limit=" + limit + "&offset=" + offset + "&date=" + current_date,
                success: function (data) {
                    onLoadedTransactionsList(data);
                    // console.log(data);
                },
                error: function (e) {
                }
            });
        }

        function onLoadedTransactionsList(data) {
            var paginData = data['pagination'] || {};
            console.log(paginData);
            pagination.render('list-pagination', loadTransactionsList, {
                count: data['count'],
                limit: paginData['limit'],
                total: paginData['total'],
                offset: paginData['offset']
            });
            list_tran = data['list'] || [];
            var html = '';

            for (var i = 1; i <= list_tran.length; i++) {
                var item = list_tran[i - 1];
                var countNumber = Number.parseInt(paginData['offset'] * paginData['limit']) + i;
                html += '<tr>'
                    + '<td class="text-left">' + countNumber + '</td>'
                    + '<td>' + item.customerName + '</td>'
                    + '<td>' + item.diagnostic + '</td>'
                    + '<td>' + item.listProcedure + '</td>'
                    + '<td>' + item.medicine + '</td>'
                    + '<td>' + item.proceMoney + '</td>'
                    + '<td>' + item.medicineMoney + '</td>'
                    + '<td>' + item.prepaid + '</td>'
                    + '<td>' + item.debt + '</td>'
                    + '<td>' + item.note + '</td>'
                    + '<td>' + '<div style="text-align: center; vertical-align: middle;">' +
                    '<button type="button" data-toggle="modal" class="btn btn-circle btn-icon edit-tran" style="margin-right: 0.5rem;"' +
                    ' href="#kt_select2_modal" data-index="' + (i - 1) + '"><i class="flaticon-edit"></i></button>' +
                    '<button type="button" class="btn btn-circle btn-icon delete-tran" data-index="' + (i - 1) + '" style="margin-left: 0.5rem"' +
                    '  ><i class="flaticon-delete"></i></button></div>' + '</td>'
                    + '</tr>';
            }
            $('#tbody-list').html(html);
        }

        document.getElementById("saveTran").addEventListener("click", createTransaction);

        // document.getElementById("edit-tran").addEventListener("click", editTransaction);

        $(document).on("click", ".edit-tran", editTransaction);

        $(document).on("click", ".delete-tran", deleteTransaction);

        function createTransaction() {
            var customerName = $('#cusName').val().trim();
            var listProcedure = $('#kt_select2_3_modal').val().join(" + ");
            var diagnostic = $('#diagnostic').val().trim();
            var proceMoney = $('#moneyPro').val() ? $('#moneyPro').val().trim() : 0;
            var medicine = $('#medicine').val().trim();
            var medicineMoney = $('#moneyMec').val() ? $('#moneyMec').val().trim() : 0;
            var pay = $('#pay').val().trim();
            var prepaid = pay.includes("/") ? pay : '';
            var debt = pay.includes("N") ? pay : '';
            var note = $('#note1').val().trim();
            var date = current_date;

            let body = {
                customerName,
                listProcedure,
                diagnostic,
                proceMoney,
                medicine,
                medicineMoney,
                prepaid,
                debt,
                note,
                date
            }
            console.log(edit_mode);
            // console.log("createTransaction ", body);
            if (!edit_mode) {
                //createTransaction

                postRequest({
                    url: "/transaction",
                    data: body,
                    success: (data) => {
                        // console.log(data);
                        $("#error-log").html("Thêm mới thành công!<br/>")
                        $('#cusName').val('');
                        $('#kt_select2_3_modal').val(null);
                        $('#diagnostic').val('');
                        $('#moneyPro').val('');
                        $('#medicine').val('');
                        $('#moneyMec').val('');
                        $('#pay').val('');

                        $('#note1').val();
                    },
                    error: (e) => {
                        console.log(e);
                        var error = e['error'];
                        if (error != null) {
                            let content = JSON.parse(error);
                            // if (content['code'] === 702) {
                            $("#error-log").html(content['message'] + ".<br/>")
                            // }
                        } else
                            $("#error-log").html("Lỗi hệ thống!<br/>")

                    }
                })
            } else {
                //edit transaction
                var id = edit_mode;
                body.id = edit_mode;
                putRequest({
                    url: '/transaction/' + edit_mode,
                    data: body,
                    success: function (data) {
                        window.location = "/tran-a-day";
                        $('#kt_select2_modal').modal('hide');
                    },
                    error: function (e) {
                        console.log(e);
                        var error = e['error'];
                        if (error != null) {
                            let content = JSON.parse(error);
                            // if (content['code'] === 702) {
                            $("#error-log").html(content['message'] + ".<br/>")
                            // }
                        } else
                            $("#error-log").html("Lỗi hệ thống!<br/>")

                    }
                });
            }

        }

        function editTransaction() {
            var index = $(this).data('index');
            var tran = list_tran[index];
            console.log('editTransaction', tran)
            edit_mode = tran.id;
            $('#cusName').val(tran.customerName);
            $('#kt_select2_3_modal').val(tran.listProcedure.split(' + '));
            $('#diagnostic').val(tran.diagnostic);
            $('#moneyPro').val(tran.proceMoney || 0);
            $('#medicine').val(tran.medicine);
            $('#moneyMec').val(tran.medicineMoney || 0);
            $('#pay').val(tran.prepaid || tran.debt);

            $('#note1').val(tran.note);
        }

        function deleteTransaction() {
            var index = $(this).data('index');
            var tran = list_tran[index];
            console.log('deleteTransaction', tran)

            Swal.fire({
                title: 'Xóa thông tin này đi nhé',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Xóa đi',
                cancelButtonText: 'Thôi không xóa nữa',
            }).then((result) => {
                if (result.value) {
                    console.log("deleting...");
                    deleteRequest({
                        url: '/transaction/' + tran.id,
                        success: function (data) {
                            window.location = "/tran-a-day";
                        },
                        error: function (e) {
                            console.log(e);
                            var error = e['error'];
                            if (error != null) {
                                let content = JSON.parse(error);
                                $("#error-log").html(content['message'] + ".<br/>")
                            } else
                                $("#error-log").html("Lỗi hệ thống!<br/>")

                        }
                    });
                }
            });
        }
    });
</script>